"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = require("fs");
const js_yaml_1 = require("js-yaml");
const command_1 = require("@oclif/command");
const client_1 = require("../../client");
const get_env_info_1 = require("../../utils/get-env-info");
class ApplyBasePolicy extends command_1.default {
    async run() {
        const { args, flags } = this.parse(ApplyBasePolicy);
        const dryRun = flags['dry-run'];
        if (dryRun) {
            this.log(`Dry run mode ON - No changes will be made to the registry`);
        }
        try {
            this.log(`${dryRun ? 'Verifying' : 'Uploading'} base policy from ${args.resourcePath}...`);
            const basePolicyContent = await fs_1.promises.readFile(args.resourcePath, { encoding: 'utf8' });
            const basePolicy = js_yaml_1.safeLoad(basePolicyContent);
            const { result: { success }, } = await client_1.uploadBasePolicy(basePolicy, {
                registryUrl: flags['registry-url'],
                authorizationHeader: flags['authorization-header'],
                dryRun,
            }, {
                timeout: flags.timeout,
            });
            if (success) {
                this.log(`Base policy from ${args.resourcePath} was ${dryRun ? 'verified' : 'uploaded'} successfully.`);
            }
            else {
                throw new Error('Something went wrong');
            }
        }
        catch (e) {
            this.error(`${dryRun ? 'Verifying' : 'Uploading'} of base policy failed. ${e}

          ${get_env_info_1.default(this.config, 'apply:base-policy', flags['registry-url'], flags['authorization-header'])}`, { ...e, exit: true });
        }
    }
}
exports.default = ApplyBasePolicy;
ApplyBasePolicy.description = 'Apply base policy';
ApplyBasePolicy.examples = [
    `
      $ stitch apply:base-policy base-policy.yaml
      Uploaded successfully!
    `,
];
ApplyBasePolicy.flags = {
    'registry-url': command_1.flags.string({ required: true, env: 'STITCH_REGISTRY_URL', description: 'Url of the registry' }),
    'dry-run': command_1.flags.boolean({ required: false, default: false, description: 'Should perform a dry run' }),
    'authorization-header': command_1.flags.string({ required: false, description: 'Custom authorization header' }),
    timeout: command_1.flags.integer({ required: false, default: 10000, description: 'Request timeout' }),
};
ApplyBasePolicy.args = [{ name: 'resourcePath', required: true }];
